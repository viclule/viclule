<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Vicente Guerrero">
    <meta name="description" content="Vicente Guerrero&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal,software">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Harris corner detector on PyCUDA"/>
<meta name="twitter:description" content="A first intruduction to GPU programming  Visit the github repository for the full code.   
The function devides the image in four different parts to process them on different streams.
These are the execution times for the different implementations:
 Python Code -&gt; ≈2.22 seconds PyCUDA – single stream -&gt; ≈0.0018 seconds PyCUDA – four streams (with concurrency) -&gt; ≈0.0015 seconds  This is the image used to test the code:   []"/>

    <meta property="og:title" content="Harris corner detector on PyCUDA" />
<meta property="og:description" content="A first intruduction to GPU programming  Visit the github repository for the full code.   
The function devides the image in four different parts to process them on different streams.
These are the execution times for the different implementations:
 Python Code -&gt; ≈2.22 seconds PyCUDA – single stream -&gt; ≈0.0018 seconds PyCUDA – four streams (with concurrency) -&gt; ≈0.0015 seconds  This is the image used to test the code:   []" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/pycuda-corner-detector/" />
<meta property="article:published_time" content="2020-01-05T19:15:12+01:00" />
<meta property="article:modified_time" content="2020-01-05T19:15:12+01:00" />


    
      <base href="/posts/pycuda-corner-detector/">
    
    <title>
  Harris corner detector on PyCUDA · Vicente Guerrero
</title>

    
      <link rel="canonical" href="/posts/pycuda-corner-detector/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.0" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      Vicente Guerrero
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/about/">About</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/services/">Services</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/contact/">Contact me</a>
          </li>
        
      
      
        
        
        
          
        
          
            
              <li class="navigation-item menu-separator">
                <span>|</span>
              </li>
              
            
            <li class="navigation-item">
              <a href="/de-de/">Deutsch</a>
            </li>
          
        
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Harris corner detector on PyCUDA</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-01-05T19:15:12&#43;01:00'>
                January 5, 5050
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              2 minutes read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        <h4 id="a-first-intruduction-to-gpu-programming">A first intruduction to GPU programming</h4>
<hr>
<p>Visit the github repository for the full code.
<a href="https://github.com/viclule/pycuda_harris_corner_detector"><img src="/icons/github-icon.png" alt="GitHub"></a>
<br/>
<br/></p>
<p>The function devides the image in four different parts to process them on different streams.</p>
<p>These are the execution times for the different implementations:</p>
<ul>
<li>Python Code -&gt; ≈2.22 seconds</li>
<li>PyCUDA – single stream -&gt; ≈0.0018 seconds</li>
<li>PyCUDA – four streams (with concurrency) -&gt; ≈0.0015 seconds</li>
</ul>
<p>This is the image used to test the code:
<br/>
<br/>
[<img src="/images/posts/harris_corner_detector.png" alt="Detector example">]
<br/></p>
<hr>
<h4 id="python-code">Python code</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> string <span style="color:#f92672">import</span> Template
<span style="color:#f92672">import</span> pycuda.driver <span style="color:#f92672">as</span> drv
<span style="color:#f92672">import</span> pycuda.tools
<span style="color:#f92672">import</span> pycuda.autoinit
<span style="color:#f92672">from</span> pycuda.compiler <span style="color:#f92672">import</span> SourceModule
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pycuda_multi_kernel</span>(img, k_harris, thresh, executions):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    Finds and returns list of corners</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :param img: grayscale image</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :param k: Harris corner constant. Usually 0.04 - 0.06</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :param thresh: The threshold above which a corner is counted</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :param executions: Number of times to be executed</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :return: corner_list: List with corners</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        :return: average_execution_time: Average execution time in seconds</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    <span style="color:#75715e"># jumping some lines ...</span>

    <span style="color:#75715e"># function template</span>
    func_mod_template <span style="color:#f92672">=</span> Template(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    #include&lt;stdio.h&gt;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    #define INDEX(a, b) a*${HEIGHT}+b</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    __global__ void corners(</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float *dest,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float *ixx,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float *ixy,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float *iyy,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        int offset,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float k,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        int threshold) {</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        unsigned int idx = threadIdx.x + threadIdx.y*blockDim.y +</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                            (blockIdx.x*(blockDim.x*blockDim.y));</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        unsigned int a = idx/${HEIGHT};</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        unsigned int b = idx</span><span style="color:#e6db74">%</span><span style="color:#e6db74">${HEIGHT};</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float sxx = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float sxy = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float syy = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float det = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float trace = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        float r = 0;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        if ((a &gt;= offset) &amp; (a &lt;= (${WIDTH}-offset - 1)) &amp;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            (b &gt;= offset) &amp; (b &lt;= (${HEIGHT}-offset - 1))) {</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            for (int bi = b - offset; bi &lt; b + offset + 1; ++bi) {</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                for (int ai = a - offset; ai &lt; a + offset + 1; ++ai) {</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                    sxx = sxx + ixx[INDEX(ai, bi)];</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                    sxy = sxy + ixy[INDEX(ai, bi)];</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                    syy = syy + iyy[INDEX(ai, bi)];</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                }</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            }</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            det = sxx*syy - sxy*sxy;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            trace = sxx + syy;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            r = det - k*(trace*trace);</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">            if ((r/10) &gt; threshold)</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">                dest[INDEX(a, b)] = r;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        }</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    }</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
    <span style="color:#75715e"># jumping some lines ...</span>

    func_mod <span style="color:#f92672">=</span> SourceModule(func_mod_template<span style="color:#f92672">.</span>substitute(HEIGHT<span style="color:#f92672">=</span>k_height,
                                                         WIDTH<span style="color:#f92672">=</span>k_width))
    pycuda_corners <span style="color:#f92672">=</span> func_mod<span style="color:#f92672">.</span>get_function(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">corners</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div>
      </div>

      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
      <p>Let's do stuff together.</p>
    
    
      
        © 2019 - 2020
      
       Vicente Guerrero 
    
    
       · 
      Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
